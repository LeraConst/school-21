# Basic CI/CD

Разработка простого **CI/CD** для проекта *SimpleBashUtils*. Сборка, тестирование, развертывание.

### Part 1. Настройка **gitlab-runner**

**== Задание ==**

##### Подними виртуальную машину *Ubuntu Server 22.04 LTS*
*Будь готов, что в конце проекта нужно будет сохранить дамп образа виртуальной машины*

##### Скачай и установи на виртуальную машину **gitlab-runner**

##### Запусти **gitlab-runner** и зарегистрируй его для использования в текущем проекте (*DO6_CICD*)
- Для регистрации понадобятся URL и токен, которые можно получить на страничке задания на платформе.

**== Решение ==**

* Установка gitlab-ruuner на виртуалку

curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash

sudo apt-get update

sudo apt-get install gitlab-runner
 
   ![скрин](screenshot/1.1.png)
 
   ![скрин](screenshot/1.2.png)

* Регистрация

sudu gitlab-runner register

   ![скрин](screenshot/1.3.png)
 
   ![скрин](screenshot/1.4.png)

### Part 2. Сборка

**== Задание ==**

#### Напиши этап для **CI** по сборке приложений из проекта *C2_SimpleBashUtils*:

##### В файле _gitlab-ci.yml_ добавь этап запуска сборки через мейк файл из проекта _C2_

##### Файлы, полученные после сборки (артефакты), сохрани в произвольную директорию со сроком хранения 30 дней.

**== Решение ==**

* Создаю файл .gitlab-ci.yml в корне проекта
* В src копирую cat и grep из проекта "SimpleBash"
 
   ![скрин](screenshot/2.1.png)

* Пушу проект
* Билд проходит успешно!

   ![скрин](screenshot/2.2.png)
 
   ![скрин](screenshot/2.3.png)

* Скачиваю файл с артефактами - все ок!

   ![скрин](screenshot/2.4.png)

### Part 3. Тест кодстайла

**== Задание ==**

#### Напиши этап для **CI**, который запускает скрипт кодстайла (*clang-format*):

##### Если кодстайл не прошел, то «зафейли» пайплайн

##### В пайплайне отобрази вывод утилиты *clang-format*

**== Решение ==**

* Добавляю статию код-стайла

   ![скрин](screenshot/3.1.png)

* Код стайл прошел успешно

   ![скрин](screenshot/3.2.png)

   ![скрин](screenshot/3.3.png)

   ![скрин](screenshot/3.4.png)

* Ломаю один из файлов, чтобы не проходил код стайл

   ![скрин](screenshot/3.5.png)

* Смотрим на ошибки(в нескольких строках содержатся лишние пробелы)

   ![скрин](screenshot/3.6.png)

### Part 4. Интеграционные тесты

**== Задание ==**

#### Напиши этап для **CI**, который запускает твои интеграционные тесты из того же проекта:

##### Запусти этот этап автоматически только при условии, если сборка и тест кодстайла прошли успешно

##### Если тесты не прошли, то «зафейли» пайплайн

##### В пайплайне отобрази вывод, что интеграционные тесты успешно прошли / провалились

**== Решение ==**

* Добавляю в тест скрипты завершение программы с результатом 1(если фейлов > 0)

   ![скрин](screenshot/4.1.png)

* Добавляю тестов в ямл

   ![скрин](screenshot/4.2.png)

* Изначально я писал проект под Мак, тесты имеют некоторые отличия с Линуксом, пришлось редачить несколько тестов

   ![скрин](screenshot/4.3.png)

* С ошибкой

   ![скрин](screenshot/4.4.png)

* Успешный

   ![скрин](screenshot/4.5.png)

* Специально ломаю файл, чтобы он не прошел стадию код стайла, тем самым проверяю, чтобы после фейла код стайла, автоматически не началась проверка стадии тестов

   ![скрин](screenshot/4.6.png)

* Все отработало успешно

   ![скрин](screenshot/4.7.png)

### Part 5. Этап деплоя

**== Задание ==**

##### Подними вторую виртуальную машину *Ubuntu Server 22.04 LTS*

#### Напиши этап для **CD**, который «разворачивает» проект на другой виртуальной машине:

##### Запусти этот этап вручную при условии, что все предыдущие этапы прошли успешно

##### Напиши bash-скрипт, который при помощи **ssh** и **scp** копирует файлы, полученные после сборки (артефакты), в директорию */usr/local/bin* второй виртуальной машины

##### В файле _gitlab-ci.yml_ добавь этап запуска написанного скрипта

##### В случае ошибки «зафейли» пайплайн

**== Решение ==**

* Тестирую ручной запуск

   ![скрин](screenshot/5.1.png)

   ![скрин](screenshot/5.2.png)

* Создаю ссшник на 1-ой машине

   ![скрин](screenshot/5.3.png)

* Копирую ссш на вторую машину

   ![скрин](screenshot/5.5.png)

* До конца не понял какое влияние было от созданиев ссш от рута и раннера(возможно это лишнее, но я допустил ошибку в скрипте, указал не тот ипишник)

   ![скрин](screenshot/5.6.png)

   ![скрин](screenshot/5.7.png)

   ![скрин](screenshot/5.8.png)

* Исправил ошибку в скрипте, стадия проходит успешно

   ![скрин](screenshot/5.9.png)

* Success выводит!

   ![скрин](screenshot/5.10.png)

* Сам скрипт

   ![скрин](screenshot/5.11.png)


### Part 6. Дополнительно. Уведомления

**gitlab-runner**.

**== Задание ==**

##### Настрой уведомления о успешном/неуспешном выполнении пайплайна через бота с именем «[ваш nickname] DO6 CI/CD» в *Telegram*

- Текст уведомления должен содержать информацию об успешности прохождения как этапа **CI**, так и этапа **CD**.
- В остальном текст уведомления может быть произвольным.

**== Решение ==**

* Пишем скрипт(токен и идишник скрыл)

   ![скрин](screenshot/6.1.png)

* Ямл

   ![скрин](screenshot/6.2.png)

* Успешное прохождение отработал!

   ![скрин](screenshot/6.3.png)

* Фейл - отработал!

   ![скрин](screenshot/6.4.png)

### Спасибо за внимание!